name: Build Command Line
on: [push]

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: Clone source code
        uses: actions/checkout@v1
      - name: Install Apple certificates
        run: |
          echo "$ascCertificates" > certs.b64
          base64 --decode certs.b64 > Certificates.p12
          security add-generic-password -a "appleseed@marquiskurt.net" -w "$ascPassword" -s "AC_PASSWORD"
          sudo security import Certificates.p12 -P "$ascCertsPassword" -k /Library/Keychains/System.keychain
        env:
          ascCertsPassword: ${{ secrets.ASC_PASSWORD }}
          ascCertificates: ${{ secrets.ASC_CERTS }}
      - name: Replace build version
        run: |
          sed -i -e "s/let build = \"beta1\"/let build = \"build$(Build.BuildNumber)\"/g" ./options.swift
      - name: Switch to Xcode 11
        run: sudo xcode-select --switch /Applications/Xcode_11.1.app
      - name: Set up ssh-agent
        uses: yakuhzi/action-ssh-agent@v1
        with:
          public: ${{ secrets.SSH_PUBLIC }}
          private: ${{ secrets.SSH_PRIVATE }}
      - name: Run xcodebuild
        run: |
          for ip in $(dig @8.8.8.8 github.com +short); do ssh-keyscan github.com,$ip; ssh-keyscan $ip; done 2>/dev/null >> ~/.ssh/known_host
          /usr/bin/xcodebuild -configuration Debug -workspace ./termina-base.xcodeproj/project.xcworkspace -scheme termina-base -destination platform=macOS build -derivedDataPath dist | /usr/local/lib/ruby/gems/2.6.0/bin/xcpretty -r junit --no-color
